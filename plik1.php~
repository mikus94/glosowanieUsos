<?php

global $wpdb;
session_start();
##sprawdzam czy dopiero wybieram pytania czy juz wybralem badz oddalem glos
if ((!isset($_POST['submit']) and empty($_POST['submit'])) and !isset($_POST['dozrobienia']) and empty($_POST['dozrobienia']) ){	
	$pytania = $wpdb->get_col( $wpdb->prepare( "SELECT Pytanie.pytanie FROM Pytanie"));
	?>
	<br><br>
	<h2>Wybierz głosowanie, które chcesz edytować:</h2>
	<br><br>

	<form method=post ><select name="pytanie">
	<?php	
	foreach($pytania as $key){
		?>
		<option value="<?php echo $key ?>"><?php echo $key ?></option>
		<?php
	}
	?>
	</select>
		
		<p>Co chcesz zrobić?</p>
		<input type="radio" name="rob" value="dodaj">Dodaj głosy
		<br><input type="radio" name="rob" value="usun">Usuń głosy
		<br><input type="radio" name="rob" value="calosc">Usuń całe głosowanie
		<br><p><input type="submit" name="submit" value="Wybierz"></p>
	</form>
	<?php
} else {
	##edycjaaaa

	if (isset($_POST['rob']) and !empty($_POST['rob']) and !isset($_POST['dozrobienia']) and empty($_POST['dozrobienia'])){
		##przechodze do edycji
		$_SESSION['dorob'] = $_POST['rob'];
		$_SESSION['pytanie'] = $_POST['pytanie'];
		
		$pyt = $_POST['pytanie'];
		$typ = $wpdb->get_col( $wpdb->prepare( "SELECT typ FROM Pytanie WHERE pytanie='$pyt'") );
		$_SESSION['typ'] = $typ[0];

		$id_pyt = $wpdb->get_col( $wpdb->prepare( "SELECT id_pytania FROM Pytanie WHERE pytanie='$typ'" ) );
		if ($_POST['rob'] == "usun" ) {
			## chce usunąć jakieś głosy
			echo "<h2>Wybierz głosy do usunięcia</h2>";
			echo "<br><big>$pyt</big></br>";
			## sprawdzam czy głos jest suwakowy czy wyboru aby odwołać się do dobrej tabeli
			$_SESSION['dorob'] = $_POST['rob'];
			$_SESSION['pytanie'] = $pyt;
			$_SESSION['typ'] = $typ[0];
			$odpowiedzi;
			if ( $typ[0] > 2 ){
				## pytanie suwakowe
				$odpowiedzi = $wpdb->get_col( $wpdb->prepare( "SELECT id_glosu FROM GlosSuwakowy WHERE id_pytania=$id_pyt[0]" ) );

			} elseif ( ($typ[0] < 3) and ($typ[0] > 0) ){
				$odpowiedzi = $wpdb->get_col( $wpdb->prepare( "SELECT id_glosu FROM GlosyWyboru WHERE id_pytania=$id_pyt[0]" ) );
			}

			if (!empty($odpowiedzi)){
				?>
					<form method=post>
				<?php
				foreach($odpowiedzi as $id_o){
					$tresc = $wpdb->get_col( $wpdb->prepare( "SELECT wartosc FROM GlosSuwakowy WHERE id_glosu=$id_o") );
					?>
					
						<input type="checkbox" name="dousuniecia[]" value=<?php echo $id_o; ?>><?php echo $tresc[0]; ?>
						<br>
					<?php
				}
				?>
						<input type="submit" name="dozrobienia" value="Wykonaj">
					</form>
				
				<?php		
			} else {
				echo "<br><big>Niestety to pytanie nie posiada jeszcze odopwiedzi, zatem nie ma czego usuwać :)</big><br>";
			}
			

		} elseif ( $_POST['rob'] == 'calosc'  ) {
			echo "<h1>Czy jesteś pewien że chcesz usunąć całe głosowanie?!</h1>";
			echo "<br><big>Głosowanie: ".$_POST['pytanie'];
			?>	<form method=post>
				<br><br><input type="submit" name="dozrobienia" value="Tak jestem pewien.">
				</form>
			<?php

		} elseif ( $_POST['rob'] == 'dodaj'  ) {
			## dodaj głosy
			echo "<h1>Wybierz jaką odpowiedź chcesz dodać, a następnie w okienku ile razy:</h1>";
			echo "<h2>Pytanie: $pyt </h2>";
			if ( ($typ[0] < 3) and ($typ[0] > 0)  ) {
				## pytania wyboru
				
				$id_pytania = $wpdb->get_col( $wpdb->prepare( "SELECT id_pytania FROM Pytanie WHERE pytanie='$pyt'" ) );
				$odpowiedzi = $wpdb->get_col( $wpdb->prepare( "SELECT id_odpowiedzi FROM Odpowiedzi WHERE id_pytania=$id_pytania[0]" ) );
				?>
					<form method=post>
						<select name="odpowiedzi">
				<?php

				foreach($odpowiedzi as $id_o){
					$tresc = $wpdb->get_col( $wpdb->prepare( "SELECT tresc FROM Odpowiedzi WHERE id_odpowiedzi=$id_o") );
					echo "tt".$tresc[0];
					print_r($tresc);
					?>
						<option value="<?php echo $id_o; ?>"><?php echo $tresc[0]; ?></option>

					<?php				
				}
				?>
						</select>
						<br><br><input type="text" name="ilerazy" value="">
						<br><br><input type="submit" name="dozrobienia" value="gotowe">
					</form>
				<?php
			} elseif ( $typ[0] == 3 ) {
				## lubie to
				## dodaj glos
				## lubie to = 1 --- nie lubie 0
				echo "<h1>Chcesz dodać głosy do pytania typu 'lubię to':</h1> ";
				echo "<h2>Pytaniem było: $tresc </h2>";
				?>
				<form method=post>
					<br><br>
					<input type="radio" name="odpowiedzi" value="1">Lubię to!
					<br><input type="radio" name="odpowiedzi" value="0">Nie lubię tego!
					<br><br>
					<input type="text" name="ilerazy" value="">
					<br><br><input type="submit" name="dozrobienia" value="Dodaj">
	
				<?php
			}
		}




	}  else {
		## doZrobienia
		$tresc = $_SESSION['pytanie'];
		if ($_SESSION['dorob'] == 'usun'){
			echo "<h1>Właśnie usunąłeś odpowiedzi do pytania:</h1>";
			echo "<h2>$tresc</h2>";
			if ( $_SESSION['typ'] > 2 ) {
				## suwakowy
				foreach($_POST['dousuniecia'] as $id_o){
					$wpdb->delete('GlosSuwakowy', array( 'id_glosu' => $id_o ), array( '%d' ) );	
				}
			} elseif ( ($_SESSION['typ'] < 3) and ($_SESSION['typ'] > 0) ) {
				## wyboru
				foreach ($_POST['dousuniecia'] as $id_o){
					$wpdb->delete('GlosyWyboru', array( 'id_glosu' => $id_o ), array( '%d' ) );
				}
			}
		} elseif ( $_SESSION['dorob'] == 'calosc'  ) {
			echo "<h1>Właśnie usunąłeś całe głosowanie:</h1>";
			echo "<h2>$tresc</h2>";
			$id_pyt = $wpdb->get_col ( $wpdb->prepare( "SELECT id_pytania FROM Pytanie WHERE pytanie='$tresc'") );
			## nie dziala....
			if ( $_SESSION['typ'] > 2 ){
				## suwakowy
				$wpdb->delete('GlosSuwakowy', array( 'id_pytania' => $id_pyt[0] ), array( '%d' ) );
				$wpdb->delete('PytanieSuwakowe', array( 'id_pytania' => $id_pyt[0] ), array( '%d' ) );
				$wpdb->delete('Pytanie', array( 'id_pytania' => $id_pyt[0] ), array( '%d' ) );

			} elseif ( ($_SESSION['typ'] < 3) and ($_SESSION['typ'] > 0) ) {
				$wpdb->delete('GlosyWyboru', array( 'id_pytania' => $id_pyt[0] ), array( '%d' ) );
				$wpdb->delete('Odpowiedzi', array( 'id_pytania' => $id_pyt[0] ), array( '%d' ) );
				$wpdb->delete('Pytanie', array( 'id_pytania' => $id_pyt[0] ), array( '%d' ) );
			}
		} elseif ( $_SESSION['dorob'] == 'dodaj' ) {
			## dodaje odpowiedzi
			## dodaje głosy jako admin żeby nie zablokowac nikomu odpowiadania na pytanie :)
			$id_os = 0;
			echo "<h1>Właśnie dodałeś do pytania:</h1>";
			echo "<h2>$tresc</h2>";
			$id_o = $_POST['odpowiedzi'];
			$id_pyt = $wpdb->get_col( $wpdb->prepare( "SELECT id_pytania FROM Pytanie WHERE pytanie='$tresc'" ) );
			$tresc_odp;
			if ( ($_SESSION['typ'] < 3) and ($_SESSION['typ'] > 0) ){
				$tresc_odp = $wpdb->get_col( $wpdb->prepare( "SELECT tresc FROM Odpowiedzi WHERE id_odpowiedzi=$id_o" ) );
			} elseif ($_SESSION['typ'] > 3 ) {
				$tresc_odp = $id_o;
			} elseif ($_SESSION['typ'] == 3){
				if ( $id_o == 1){
					$tresc_odp = 'Lubię to!';
				} else {
					$tresc_odp = 'Nie lubię tego!';
				}
			}
			echo "<br><big>$tresc_odp[0], </big>";
			echo "".$_POST['ilerazy']." razy.<br>";
			for($i = 1; $i <= $_POST['ilerazy']; $i++){
				if ( ($_SESSION['typ'] < 3) and ($_SESSION['typ'] > 0) ){
					$wpdb->insert(
						'GlosyWyboru',
						array(
							id_osoby => $id_os,
							id_pytania => $id_pyt[0],
							id_odpowiedzi => $_POST['odpowiedzi']
						),
						array(
							'%d',
							'%d',
							'%d'
						)
					);
				} elseif ( $_SESSION['typ'] > 2	) {
					$wpdb->insert(
						'GlosSuwakowy',
						array(
							id_osoby => $id_os,
							id_pytania => $id_pyt[0],
							wartosc => $_POST['odpowiedzi']

						),
						array(
							'%d',
							'%d',
							'%d'
						)
					);
				}

			}
			
		}
	}
}


?>
